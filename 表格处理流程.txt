
-- 销售去零表 普通销售+去零
SELECT *
into 销售去零表
from 原始数据
where 销售类别="普通销售"
and 销售数量>0;

-- 门店平均价格表
select 分部,
 门店代码,
 商品编码,
 开票日期,
 sum(销售数量) as 日销售量,
 sum(销售金额) as 日销售额,
 sum(折扣金额+促销积分) as 日折扣额,
 sum(折扣金额+促销积分)/sum(销售金额) as 门店平均优惠率,
 sum(销售金额-折扣金额-促销积分)/sum(销售数量) as 门店平均成交价
into 门店平均价格表
from 销售去零表
group by 分部,
 门店代码,
 商品编码,
 开票日期;

-- 分部平均价格表
select 分部,
 商品编码,
 开票日期,
 sum(销售数量) as 日销售量,
 sum(销售金额) as 日销售额,
 sum(折扣金额+促销积分) as 日折扣额,
 sum(折扣金额+促销积分)/sum(销售金额) as 分部平均优惠率,
 sum(销售金额-折扣金额-促销积分)/sum(销售数量) as 分部平均成交价
into 分部平均价格表
from 销售去零表
group by 分部,
 商品编码,
 开票日期;

-- 销售会员表 会员编码为11位
select *
into 销售会员表
from 销售去零表
where 会员卡号 like "???????????";

--  会员处理和非会员处理 见分支
-- select 分部,门店代码,门店名称,零售单号,提货单号,商品编码,商品名称,


--连接表  分部门店平均值连接
select 门店平均价格表.分部 as 分部,
 门店平均价格表.门店代码 as 门店代码,
 门店平均价格表.商品编码 as 商品编码,
 门店平均价格表.开票日期 as 开票日期,
 分部平均价格表.日销售量 as 分部日销售量,
 分部平均价格表.日销售额 as 分部日销售额,
 分部平均价格表.日折扣额 as 分部日折扣额,
 分部平均价格表.分部平均成交价 as 分部平均成交价,
 分部平均价格表.分部平均优惠率 as 分部平均优惠率，
 门店平均价格表.日销售量 as 门店日销售量,
 门店平均价格表.日销售额 as 门店日销售额,
 门店平均价格表.日折扣额 as 门店日折扣额,
 门店平均价格表.门店平均成交价 as 门店平均成交价,
 门店平均价格表.门店平均优惠率 as 门店平均优惠率
into 连接表1
from 门店平均价格表
inner join 分部平均价格表
on 门店平均价格表.分部=分部平均价格表.分部
and 门店平均价格表.商品编码=分部平均价格表.商品编码
and 门店平均价格表.开票日期=分部平均价格表.开票日期;

-- 连接表2
select 销售会员表.ID as ID,
 销售会员表.门店代码 as 门店代码,
 销售会员表.商品编码 as 商品编码,
 销售会员表.开票日期 as 开票日期,
 销售会员表.会员卡号 as 会员卡号,
 销售会员表.客户名称 as 客户名称,
 销售会员表.销售数量 as 销售数量,
 销售会员表.销售金额 as 销售金额,
 销售会员表.折扣金额 as 折扣金额,
 销售会员表.促销积分 as 促销积分,
 连接表1.分部平均优惠率 as 分部平均优惠率,
 连接表1.门店平均优惠率 as 门店平均优惠率,
 连接表1.分部平均成交价 as 分部平均成交价,
 连接表1.门店平均成交价 as 门店平均成交价
into 连接表2
from 销售会员表
inner join 连接表1
on 销售会员表.门店代码 = 连接表1.门店代码
and 销售会员表.商品编码 = 连接表1.商品编码
and 销售会员表.开票日期 = 连接表1.开票日期;

-- 错误！！！ 结果表  总折扣
select 会员卡号,
 商品编码,
 sum(销售数量) as 总销售数量,
 sum(销售金额) as 总销售金额,
 sum(折扣金额+促销积分) as 总折扣额,
 sum(折扣金额+促销积分)/sum(销售金额) as 优惠率,
 分部平均优惠率 as 分部平均优惠率,
 门店平均优惠率 as 门店平均优惠率,
 sum(销售金额-折扣金额-促销积分)/sum(销售数量) as 成交价,
 分部平均成交价 as 分部平均成交价,
 门店平均成交价 as 门店平均成交价,
 sum（分部平均成交价*销售数量-销售金额+折扣金额+促销积分）as 分部平均总差额,
 sum（门店平均成交价*销售数量-销售金额+折扣金额+促销积分）as 门店平均总差额
into 结果表
from 连接表2
group by 会员卡号,
商品编码;

-- 结果表1 总折扣

select 会员卡号,
 sum(销售数量) as 总销售数量,
 sum(销售金额) as 总销售金额,
 sum(折扣金额+促销积分) as 总折扣额,
 sum(折扣金额+促销积分)/sum(销售金额) as 优惠率,
 sum(销售金额-折扣金额-促销积分)/sum(销售数量) as 成交价,
 sum(分部平均成交价*销售数量-销售金额+折扣金额+促销积分) as 分部平均总差额,
 sum(门店平均成交价*销售数量-销售金额+折扣金额+促销积分) as 门店平均总差额
into 结果表1
from 连接表2
group by 会员卡号;

-- 结果表 商品折扣

select 会员卡号,
 商品编码,
 sum(销售数量) as 总销售数量,
 sum(销售金额) as 总销售金额,
 sum(折扣金额+促销积分) as 总折扣额,
 sum(折扣金额+促销积分)/sum(销售金额) as 优惠率,
 sum(销售金额-折扣金额-促销积分)/sum(销售数量) as 成交价,
 sum(分部平均成交价*销售数量-销售金额+折扣金额+促销积分) as 分部平均总差额,
 sum(门店平均成交价*销售数量-销售金额+折扣金额+促销积分) as 门店平均总差额
into 结果表2
from 连接表2
group by 会员卡号,
商品编码;




